<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>TIMS </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f2ff; --glass: rgba(255, 255, 255, 0.05); }
        body { background: #080810; color: #fff; font-family: 'Inter', sans-serif; min-height: 100vh; }
        h1, h2, h3, h5 { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .glass-card { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; }
        .form-control, .form-select { background: rgba(0,0,0,0.5) !important; color: var(--neon-blue) !important; border: 1px solid rgba(255,255,255,0.1); }
        .btn-cyber { border: 1px solid var(--neon-blue); color: var(--neon-blue); background: none; font-weight: bold; transition: 0.3s; }
        .btn-cyber:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .status-badge { font-size: 0.75rem; padding: 3px 10px; border-radius: 12px; border: 1px solid var(--neon-blue); color: var(--neon-blue); }
        .inventory-img { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; }
    </style>
</head>
<body>
    <div id="app" class="container py-5">
        <header class="text-center mb-5">
            <h1 style="color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue);">TIMS BY MANGAL</h1>
        </header>

        <div v-if="view === 'login'" class="row justify-content-center">
            <div class="col-md-5 glass-card text-center">
                <h3>ACCESS PANEL</h3>
                <input v-model="loginEmail" class="form-control my-3" placeholder="Email Address">
                <input v-model="loginPass" type="password" class="form-control mb-4" placeholder="Security Key">
                <button @click="handleLogin" class="btn btn-cyber w-100 py-2">LOGIN</button>
            </div>
        </div>

        <div v-if="view !== 'login'" class="d-flex justify-content-between align-items-center mb-4 glass-card py-3 px-4">
            <div>
                <h4 class="m-0 text-info">{{currentUser.name}}</h4>
                <span class="badge bg-primary text-uppercase">{{currentUser.role}}</span>
            </div>
            <button @click="logout" class="btn btn-sm btn-outline-danger px-4">LOGOUT</button>
        </div>

        <div v-if="view === 'admin'" class="row g-4">
            <div class="col-lg-4">
                <div class="glass-card">
                    <h5>Add Mechanic</h5>
                    <input v-model="mech.name" class="form-control mb-2" placeholder="Full Name">
                    <input v-model="mech.email" class="form-control mb-2" placeholder="Email">
                    <input v-model="mech.mobile" maxlength="10" class="form-control mb-2" placeholder="Mobile">
                    <input v-model="mech.password" type="password" class="form-control mb-2" placeholder="Password">
                    <select v-model="mech.level" class="form-select mb-3">
                        <option>Expert</option><option>Medium</option><option>New Recruit</option><option>Trainee</option>
                    </select>
                    <button @click="registerMechanic" class="btn btn-cyber w-100">REGISTER</button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="glass-card">
                    <h5>Add New Tool</h5>
                    <input v-model="tool.title" class="form-control mb-2" placeholder="Tool Name">
                    <select v-model="tool.category" class="form-select mb-2">
                        <option value="" disabled>Select Category</option>
                        <option v-for="cat in categories" :key="cat" :value="cat">{{cat}}</option>
                    </select>
                    <input v-model="tool.quantity" type="number" class="form-control mb-2" placeholder="Available Qty">
                    <input v-model="tool.image" class="form-control mb-3" placeholder="Image URL">
                    <button @click="addTool" class="btn btn-cyber w-100" style="border-color: #bc13fe; color: #bc13fe;">ADD ASSET</button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="glass-card border-warning">
                    <h5>Issue Tool</h5>
                    <select v-model="issueData.mechanicId" class="form-select mb-2">
                        <option value="">Select Mechanic</option>
                        <option v-for="m in mechanics" :value="m._id">{{m.name}}</option>
                    </select>
                    <select v-model="issueData.toolId" class="form-select mb-2">
                        <option value="">Select Tool</option>
                        <option v-for="t in tools" :value="t._id">{{t.title}} (Stock: {{t.quantity}})</option>
                    </select>
                    <input v-model="issueData.qty" type="number" class="form-control mb-3">
                    <button @click="issueTool" class="btn btn-cyber w-100" style="border-color:orange; color:orange;">ISSUE ASSET</button>
                </div>
            </div>

            <div class="col-12">
                <div class="glass-card">
                    <h5>User-Wise Issued Report</h5>
                    <table class="table table-dark mt-3 align-middle">
                        <thead><tr><th>Mechanic</th><th>Tool</th><th>Qty</th><th>Issued Date</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr v-for="issue in allIssues">
                                <td>{{issue.mechanicName}}</td>
                                <td>{{issue.toolTitle}}</td>
                                <td>{{issue.quantity}}</td>
                                <td>{{ new Date(issue.dateIssued).toLocaleDateString() }}</td>
                                <td><span class="status-badge">Issued</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="view === 'mechanic'" class="row g-4">
            <div class="col-md-6 glass-card">
                <h5>Inventory</h5>
                <div v-for="t in tools" class="d-flex justify-content-between border-bottom border-secondary py-2 align-items-center">
                    <div>
                        <img :src="t.image || 'https://via.placeholder.com/40'" class="inventory-img me-2">
                        <span>{{t.title}} <small class="text-white-50">({{t.category}})</small></span>
                    </div>
                    <span :class="t.quantity > 0 ? 'text-success' : 'text-danger'">{{t.quantity}} Units</span>
                </div>
            </div>
            <div class="col-md-6 glass-card" style="border-left: 4px solid var(--neon-blue);">
                <h5 class="text-info">Your Active Inventory</h5>
                <div v-for="i in sessionIssued" :key="i._id" class="bg-dark p-3 rounded mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="d-block fw-bold text-info">{{i.toolTitle}} (x{{i.quantity}})</span>
                            <small class="text-white-50">Issued: {{ new Date(i.dateIssued).toLocaleDateString() }}</small>
                        </div>
                        <button @click="returnTool(i._id)" class="btn btn-sm btn-outline-warning">Return</button>
                    </div>
                </div>
                <p v-if="sessionIssued.length === 0" class="text-center py-4 text-white-50">No tools currently held.</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    view: 'login', currentUser: { name: '', role: '', id: '' }, loginEmail: '', loginPass: '',
                    mechanics: [], tools: [], allIssues: [], sessionIssued: [],
                    categories: ['Screw Driver', 'Wrench', 'Plier', 'Hammer', 'Power Tools', 'Diagnostic'],
                    mech: { name: '', email: '', mobile: '', password: '', level: 'Trainee' },
                    tool: { title: '', category: '', quantity: 1, image: '' },
                    issueData: { mechanicId: '', toolId: '', qty: 1 }
                }
            },
            methods: {
                async handleLogin() {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email: this.loginEmail, password: this.loginPass })
                    });
                    const data = await res.json();
                    if(res.ok) { 
                        // SAVE USER DATA FIRST
                        this.currentUser = data.user;
                        this.view = data.user.role.toLowerCase(); 
                        // NOW FETCH DATA (Wait for user ID to be ready)
                        await this.loadData();
                    } else { alert(data.msg); }
                },
                async registerMechanic() {
                    const res = await fetch('/api/auth/register-mechanic', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.mech)
                    });
                    const data = await res.json(); alert(data.msg);
                    if(res.ok) { this.mech = { name: '', email: '', mobile: '', password: '', level: 'Trainee' }; await this.loadData(); }
                },
                async addTool() {
                    const res = await fetch('/api/tools/add', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.tool)
                    });
                    if(res.ok) { 
                        alert("Tool Added to Inventory"); 
                        this.tool = { title: '', category: '', quantity: 1, image: '' };
                        await this.loadData(); 
                    }
                },
                async issueTool() {
                    const res = await fetch('/api/tools/issue', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            toolId: this.issueData.toolId, 
                            mechanicId: this.issueData.mechanicId, 
                            qtyIssued: this.issueData.qty 
                        })
                    });
                    if(res.ok) { alert("Tool Issued"); await this.loadData(); }
                },
                async returnTool(issueId) {
                    const res = await fetch('/api/tools/return', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ issueId })
                    });
                    if(res.ok) { alert("Asset Returned"); await this.loadData(); }
                },
                async loadData() {
                    const [resM, resT, resA] = await Promise.all([
                        fetch('/api/admin/mechanics'), fetch('/api/admin/tools'), fetch('/api/admin/all-issues')
                    ]);
                    this.mechanics = await resM.json(); 
                    this.tools = await resT.json(); 
                    this.allIssues = await resA.json();
                    
                    // FIXED: Ensure mechanic custody fetches correctly using this.currentUser.id
                    if(this.currentUser && this.currentUser.id && this.view === 'mechanic') {
                        const resC = await fetch(`/api/mechanic/custody/${this.currentUser.id}`);
                        this.sessionIssued = await resC.json();
                    }
                },
                logout() { this.view = 'login'; this.currentUser = { name: '', role: '', id: '' }; this.sessionIssued = []; }
            }
        }).mount('#app')
    </script>
</body>
</html>