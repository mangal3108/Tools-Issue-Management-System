<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon-blue: #00f2ff; 
            --neon-purple: #bc13fe; 
            --glass: rgba(255, 255, 255, 0.03); 
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body {
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #080810 100%);
            color: #fff; font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden;
        }
        h1, h2, h3, h5 { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; text-transform: uppercase; }
        
        /* Futuristic Glass Cards */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 15px;
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.6); transition: 0.4s ease;
            padding: 25px;
        }
        .glass-card:hover { border-color: rgba(0, 242, 255, 0.4); transform: translateY(-5px); }

        /* Neon Form Elements */
        .form-control, .form-select {
            background: rgba(0, 0, 0, 0.4) !important; border: 1px solid var(--glass-border);
            color: var(--neon-blue) !important; border-radius: 8px; padding: 12px;
        }
        .form-control:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .form-control::placeholder { color: rgba(255, 255, 255, 0.3); }

        /* Cyber Buttons */
        .btn-cyber {
            background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue);
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .btn-cyber:hover {
            background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue);
        }
        .btn-purple { border-color: var(--neon-purple); color: var(--neon-purple); }
        .btn-purple:hover { background: var(--neon-purple); color: #fff; box-shadow: 0 0 20px var(--neon-purple); }

        /* Table Styling */
        .table { color: #e0e0e0; border-color: var(--glass-border); }
        .table thead th { border-bottom: 2px solid var(--neon-blue); color: var(--neon-blue); font-family: 'Orbitron'; font-size: 0.8rem; }
        
        /* Status Elements */
        .status-badge {
            font-size: 0.7rem; padding: 4px 10px; border-radius: 20px;
            background: rgba(0, 242, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue);
        }
    </style>
</head>
<body>
    <div id="app" class="container py-5">
        
        <header class="text-center mb-5">
            <h1 style="color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue);">Tool ISSUE MANAGEMENT SYSTEM BY MANGAL <small class="fs-6 text-white-50">Enterprise v2.0</small></h1>
            <div style="height: 1px; width: 200px; background: linear-gradient(90deg, transparent, var(--neon-blue), transparent); margin: 15px auto;"></div>
        </header>

        <div v-if="view === 'login'" class="row justify-content-center">
            <div class="col-md-5">
                <div class="glass-card text-center p-5">
                    <h3 class="mb-4">System Access</h3>
                    <div class="mb-3 text-start">
                        <label class="small text-white-50 mb-1">Personnel Email</label>
                        <input v-model="loginEmail" type="email" class="form-control" placeholder="admin@tims.com">
                    </div>
                    <div class="mb-4 text-start">
                        <label class="small text-white-50 mb-1">Security Key</label>
                        <input v-model="loginPass" type="password" class="form-control" placeholder="••••••••">
                    </div>
                    <button @click="handleLogin" class="btn btn-cyber w-100 py-3">Initialize Session</button>
                </div>
            </div>
        </div>

        <div v-if="view === 'admin'">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fs-4 m-0">Console: <span class="text-info">Root_Admin</span></h2>
                <button @click="logout" class="btn btn-sm btn-outline-danger px-4">Terminate Session [D.2]</button>
            </div>
            
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="glass-card h-100">
                        <h5 class="text-info mb-4">Personnel Sync</h5>
                        <input v-model="mech.name" class="form-control mb-2" placeholder="Full Name">
                        <input v-model="mech.email" class="form-control mb-2" placeholder="Network Email">
                        <input v-model="mech.mobile" maxlength="10" class="form-control mb-2" placeholder="Mobile UID">
                        <input v-model="mech.password" type="password" class="form-control mb-2" placeholder="Security Key">
                        <select v-model="mech.level" class="form-select mb-3">
                            <option>Expert</option><option>Medium</option><option>New Recruit</option><option>Trainee</option>
                        </select>
                        <input v-model="mech.picture" class="form-control mb-4" placeholder="Avatar URL">
                        <button @click="registerMechanic" class="btn btn-cyber w-100">Sync User [B.1]</button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="glass-card h-100">
                        <h5 class="text-info mb-4">Asset Matrix</h5>
                        <input v-model="tool.title" class="form-control mb-2" placeholder="Asset Title">
                        <input v-model="tool.category" class="form-control mb-2" placeholder="Category Type">
                        <input v-model="tool.quantity" type="number" class="form-control mb-2" placeholder="Quantity Units">
                        <input v-model="tool.image" class="form-control mb-4" placeholder="Reference URL">
                        <button @click="addTool" class="btn btn-cyber btn-purple w-100">Add Asset [B.3]</button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="glass-card h-100">
                        <h5 class="text-warning mb-4">Deployment</h5>
                        <label class="small text-white-50 mb-1">Mechanic Selection</label>
                        <select v-model="issueData.mechanicId" class="form-select mb-2">
                            <option v-for="m in mechanics" :value="m._id">{{m.name}}</option>
                        </select>
                        <label class="small text-white-50 mb-1">Asset Selection</label>
                        <select v-model="issueData.toolId" class="form-select mb-2">
                            <option v-for="t in tools" :value="t._id">{{t.title}} (In Stock: {{t.quantity}})</option>
                        </select>
                        <label class="small text-white-50 mb-1">Deployment Units</label>
                        <input v-model="issueData.qty" type="number" class="form-control mb-4" placeholder="0">
                        <button @click="issueTool" class="btn btn-cyber w-100" style="border-color: #ffa500; color: #ffa500;">Execute Issue [B.4]</button>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card">
                        <h5 class="mb-4">Intelligence Report [B.5]</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Personnel Profile</th>
                                        <th>Level</th>
                                        <th>Active Assets</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="m in mechanics">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img :src="m.picture || 'https://via.placeholder.com/40'" class="rounded-circle me-3 border border-info" width="35" height="35">
                                                <span class="fw-bold">{{m.name}}</span>
                                            </div>
                                        </td>
                                        <td><span class="status-badge">{{m.level}}</span></td>
                                        <td class="text-info fw-bold">{{getIssuedCount(m.name)}} Units</td>
                                        <td><span class="text-success">● Synchronized</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'mechanic'">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fs-4 m-0">Hub: <span class="text-info">Mechanic_Interface</span></h2>
                <button @click="logout" class="btn btn-sm btn-outline-danger px-4">Terminate Session [D.2]</button>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="glass-card h-100">
                        <h5 class="text-info mb-4">Inventory Matrix [C.1]</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Asset</th><th>Qty</th><th>Action</th></tr></thead>
                                <tbody>
                                    <tr v-for="t in tools">
                                        <td>{{t.title}}</td>
                                        <td :class="t.quantity > 0 ? 'text-success' : 'text-danger'">{{t.quantity}}</td>
                                        <td><span class="text-white-50 small">Reserved</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="glass-card h-100 border-warning">
                        <h5 class="text-warning mb-4">Active Custody [C.2]</h5>
                        <div v-for="i in sessionIssued" class="glass-card mb-3 p-3 border-0 bg-dark d-flex justify-content-between align-items-center">
                            <div>
                                <span class="d-block fw-bold text-info">{{i.title}}</span>
                                <small class="text-white-50">Units: {{i.qty}}</small>
                            </div>
                            <button @click="returnTool(i)" class="btn btn-sm btn-cyber py-1">Initiate Return [C.3]</button>
                        </div>
                        <div v-if="sessionIssued.length === 0" class="text-center py-5 text-white-50">
                            <p class="m-0">No active assets in custody.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    view: 'login', loginEmail: '', loginPass: '',
                    mechanics: [], tools: [], sessionIssued: [], allIssues: [],
                    mech: { name: '', email: '', mobile: '', password: '', level: 'Trainee', picture: '' },
                    tool: { title: '', category: '', quantity: 1, image: '' },
                    issueData: { mechanicId: '', toolId: '', qty: 1 }
                }
            },
            methods: {
                async handleLogin() {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email: this.loginEmail, password: this.loginPass })
                    });
                    const data = await res.json();
                    if(res.ok) {
                        this.view = data.user.role.toLowerCase();
                        this.loadData();
                    } else { alert(data.msg); }
                },
                getIssuedCount(userName) {
                    return this.allIssues.filter(i => i.user === userName).reduce((acc, curr) => acc + parseInt(curr.qty), 0);
                },
                async registerMechanic() {
                    const res = await fetch('/api/auth/register-mechanic', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.mech)
                    });
                    const data = await res.json(); alert(data.msg);
                    if(res.ok) this.loadData();
                },
                async addTool() {
                    await fetch('/api/tools/add', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.tool)
                    });
                    alert("Asset Synced"); this.loadData();
                },
                async issueTool() {
                    const res = await fetch('/api/tools/issue', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ toolId: this.issueData.toolId, qtyIssued: this.issueData.qty })
                    });
                    if(res.ok) {
                        const t = this.tools.find(x => x._id === this.issueData.toolId);
                        const m = this.mechanics.find(x => x._id === this.issueData.mechanicId);
                        this.sessionIssued.push({ title: t.title, toolId: t._id, qty: this.issueData.qty });
                        this.allIssues.push({ user: m.name, qty: this.issueData.qty });
                        alert("Deployment Complete"); this.loadData();
                    } else { alert("Deployment Error"); }
                },
                async returnTool(i) {
                    await fetch('/api/tools/return', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ toolId: i.toolId, qtyReturned: i.qty })
                    });
                    this.sessionIssued = this.sessionIssued.filter(x => x.toolId !== i.toolId);
                    this.loadData(); alert("Asset Recovered");
                },
                async loadData() {
                    const resM = await fetch('/api/admin/mechanics'); this.mechanics = await resM.json();
                    const resT = await fetch('/api/admin/tools'); this.tools = await resT.json();
                },
                logout() { this.view = 'login'; this.sessionIssued = []; }
            }
        }).mount('#app')
    </script>
</body>
</html>